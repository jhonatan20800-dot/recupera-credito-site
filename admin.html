<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — Recupera Crédito</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand:#e11d48; /* rose-600 */
      --brand-2:#f97316; /* amber-500 */
      --ink:#0f172a;
      --muted:#475569;
      --card:#ffffff;
      --bg:#f8fafc;
      --border:#e2e8f0;
    }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .brand-grad{background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    .badge{font-size:.75rem;padding:.15rem .5rem;border-radius:.5rem;font-weight:700}
    .b-novo{background:#eef2ff;color:#4338ca}
    .b-contato{background:#fff7ed;color:#c2410c}
    .b-qualificado{background:#ecfeff;color:#155e75}
    .b-fechado{background:#ecfdf5;color:#065f46}
    .b-descartado{background:#fef2f2;color:#991b1b}
    .row-new{animation:flash 1.2s ease-in-out 1}
    @keyframes flash{0%{background:#fff7ed}100%{background:transparent}}
    .thead-sticky thead th{position:sticky;top:0;z-index:2;box-shadow:0 1px 0 var(--border)}
    .table-dense td,.table-dense th{padding:.55rem .6rem}
    .shadow-soft{box-shadow:0 6px 24px rgba(2,8,23,.06)}
    .card{background:var(--card);border:1px solid var(--border)}
    .btn{transition:transform .05s ease}
    .btn:active{transform:scale(.98)}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="card shadow-soft">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-8 w-8 rounded-lg brand-grad"></span>
        <div class="leading-tight">
          <div class="font-black tracking-tight">RECUPERA <span class="text-[var(--brand)]">CRÉDITO</span></div>
          <div class="text-xs text-slate-500 -mt-0.5">Painel administrativo</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-export" class="btn text-sm px-3 py-1.5 rounded border">Exportar CSV</button>
        <button id="btn-sair" class="btn text-sm px-3 py-1.5 rounded border">Sair</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- LOGIN (modal central) -->
    <section id="login" class="fixed inset-0 z-50 grid place-items-center bg-black/40">
      <div class="card shadow-soft w-full max-w-md rounded-2xl overflow-hidden">
        <div class="brand-grad h-1.5 w-full"></div>
        <div class="p-6">
          <h1 class="text-xl font-extrabold mb-1">Acesso restrito</h1>
          <p class="text-sm text-slate-500 mb-4">Use suas credenciais para entrar no painel.</p>
          <form id="form-login" class="space-y-3">
            <div>
              <label class="text-xs text-slate-500">Usuário</label>
              <input name="user" class="w-full border rounded px-3 py-2" value="ADMIN" placeholder="Usuário">
            </div>
            <div>
              <label class="text-xs text-slate-500">Senha</label>
              <input name="pass" class="w-full border rounded px-3 py-2" type="password" value="recupera123" placeholder="Senha">
            </div>
            <button class="w-full bg-[var(--brand)] hover:brightness-110 text-white rounded px-3 py-2 font-bold">Entrar</button>
            <p class="text-xs text-slate-400">Login de exemplo: <b>ADMIN</b> / <b>recupera123</b></p>
          </form>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden space-y-6">
      <!-- RESUMO -->
      <div class="grid sm:grid-cols-2 lg:grid-cols-5 gap-3">
        <div class="card rounded-xl p-4">
          <div class="text-xs text-slate-500">Total</div>
          <div id="m-total" class="text-2xl font-extrabold">0</div>
        </div>
        <div class="card rounded-xl p-4">
          <div class="text-xs text-slate-500">Novo</div>
          <div id="m-novo" class="text-2xl font-extrabold">0</div>
        </div>
        <div class="card rounded-xl p-4">
          <div class="text-xs text-slate-500">Em contato</div>
          <div id="m-contato" class="text-2xl font-extrabold">0</div>
        </div>
        <div class="card rounded-xl p-4">
          <div class="text-xs text-slate-500">Qualificado</div>
          <div id="m-qualificado" class="text-2xl font-extrabold">0</div>
        </div>
        <div class="card rounded-xl p-4">
          <div class="text-xs text-slate-500">Fechado</div>
          <div id="m-fechado" class="text-2xl font-extrabold">0</div>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="card rounded-xl p-4 shadow-soft">
        <div class="grid md:grid-cols-5 gap-3">
          <input id="q" class="border rounded px-3 py-2 md:col-span-2" placeholder="Buscar por nome, WhatsApp ou cidade…">
          <select id="f-tipo" class="border rounded px-3 py-2">
            <option value="">Tipo (todos)</option>
            <option>PF</option><option>PJ</option>
          </select>
          <select id="f-status" class="border rounded px-3 py-2">
            <option value="">Status (todos)</option>
            <option>Novo</option><option>Em contato</option>
            <option>Qualificado</option><option>Fechado</option>
            <option>Descartado</option>
          </select>
          <select id="sort" class="border rounded px-3 py-2">
            <option value="created_at:desc">Mais recentes</option>
            <option value="created_at:asc">Mais antigos</option>
            <option value="nome:asc">Nome (A→Z)</option>
            <option value="nome:desc">Nome (Z→A)</option>
          </select>
        </div>
        <div class="flex items-center justify-between mt-3">
          <div class="text-xs text-slate-500">Autoatualização a cada <b>10s</b>.</div>
          <div class="flex items-center gap-2">
            <button id="btn-refresh" class="btn px-3 py-2 rounded bg-slate-900 text-white">Atualizar</button>
          </div>
        </div>
      </div>

      <!-- TABELA -->
      <div id="table-card" class="card rounded-xl overflow-hidden shadow-soft thead-sticky">
        <table class="w-full text-sm table-dense">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2">Quando</th>
              <th class="text-left p-2">Tipo</th>
              <th class="text-left p-2">Nome</th>
              <th class="text-left p-2">WhatsApp</th>
              <th class="text-left p-2">Cidade</th>
              <th class="text-left p-2">Tempo</th>
              <th class="text-left p-2">Limite</th>
              <th class="text-left p-2">Status</th>
              <th class="text-left p-2">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <!-- SKELETON (carregando) -->
        <div id="loading" class="p-6 grid gap-2">
          <div class="h-3 bg-slate-100 animate-pulse rounded"></div>
          <div class="h-3 bg-slate-100 animate-pulse rounded"></div>
          <div class="h-3 bg-slate-100 animate-pulse rounded"></div>
        </div>

        <!-- VAZIO -->
        <div id="empty" class="hidden p-10 text-center text-slate-500">
          Nenhum registro encontrado com os filtros atuais.
        </div>
      </div>

      <div class="flex items-center justify-between text-xs text-slate-500">
        <div id="count">0 registro(s)</div>
        <div class="flex items-center gap-2">
          <span class="badge b-novo">Novo</span>
          <span class="badge b-contato">Em contato</span>
          <span class="badge b-qualificado">Qualificado</span>
          <span class="badge b-fechado">Fechado</span>
          <span class="badge b-descartado">Descartado</span>
        </div>
      </div>
    </section>
  </main>

  <!-- TOASTS -->
  <div id="toasts" class="fixed top-4 right-4 z-[60] space-y-2"></div>

  <script>
    // ========= CONFIG =========
    const WPP = '5521983941778'; // DDI + DDD + número do seu atendimento

    // ========= ELEMENTOS =========
    const loginBox = document.getElementById('login');
    const appBox   = document.getElementById('app');
    const tbody    = document.getElementById('tbody');
    const loading  = document.getElementById('loading');
    const emptyEl  = document.getElementById('empty');
    const countLbl = document.getElementById('count');
    const mTot = document.getElementById('m-total');
    const mNovo = document.getElementById('m-novo');
    const mContato = document.getElementById('m-contato');
    const mQuali = document.getElementById('m-qualificado');
    const mFechado = document.getElementById('m-fechado');

    const q = document.getElementById('q');
    const fTipo = document.getElementById('f-tipo');
    const fStatus = document.getElementById('f-status');
    const sortSel = document.getElementById('sort');

    // ========= HELPERS =========
    const dt = s => new Date(s).toLocaleString('pt-BR');
    const phone = s => (s||'').replace(/[^\d]/g,'');
    const csv = rows => {
      if(!rows.length) return '';
      const keys = Object.keys(rows[0]);
      const head = keys.join(',');
      const body = rows.map(r=>keys.map(k=>JSON.stringify(r[k]??'')).join(',')).join('\n');
      return head+'\n'+body;
    };
    const badge = (st) => {
      const m = {'Novo':'b-novo','Em contato':'b-contato','Qualificado':'b-qualificado','Fechado':'b-fechado','Descartado':'b-descartado'};
      return `<span class="badge ${m[st]||'b-novo'}">${st}</span>`;
    };
    function toast(msg,type='ok'){
      const el = document.createElement('div');
      el.className = 'rounded-lg px-3 py-2 text-sm text-white shadow-lg '+(type==='ok'?'bg-emerald-600':'bg-rose-600');
      el.textContent = msg;
      document.getElementById('toasts').appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 1800);
      setTimeout(()=>el.remove(), 2300);
    }

    // ========= ESTADO =========
    let ALL = [];
    let lastIds = new Set();
    let poller = null;

    // ========= RENDER =========
    function updateSummary(rows){
      mTot.textContent = rows.length;
      mNovo.textContent = rows.filter(r=>r.status==='Novo').length;
      mContato.textContent = rows.filter(r=>r.status==='Em contato').length;
      mQuali.textContent = rows.filter(r=>r.status==='Qualificado').length;
      mFechado.textContent = rows.filter(r=>r.status==='Fechado').length;
    }

    function applyFilters(){
      let rows = [...ALL];
      const term = q.value.toLowerCase().trim();
      if(term){
        rows = rows.filter(r =>
          (r.nome||'').toLowerCase().includes(term) ||
          (r.whatsapp||'').toLowerCase().includes(term) ||
          (r.cidade||'').toLowerCase().includes(term)
        );
      }
      if(fTipo.value) rows = rows.filter(r => r.tipo === fTipo.value);
      if(fStatus.value) rows = rows.filter(r => r.status === fStatus.value);

      const [k,dir] = sortSel.value.split(':');
      rows.sort((a,b)=>{
        const A = (a[k]||'').toString().toLowerCase();
        const B = (b[k]||'').toString().toLowerCase();
        if(A<B) return dir==='asc'?-1:1;
        if(A>B) return dir==='asc'?1:-1;
        return 0;
      });

      render(rows);
      updateSummary(rows);
    }

    function render(rows){
      countLbl.textContent = `${rows.length} registro(s)`;
      loading.classList.add('hidden');
      emptyEl.classList.toggle('hidden', rows.length>0);

      tbody.innerHTML = rows.map(r=>{
        const isNew = !lastIds.has(r.id);
        return `
        <tr class="border-t ${isNew?'row-new':''}">
          <td class="p-2 whitespace-nowrap">${dt(r.created_at)}</td>
          <td class="p-2">${r.tipo}</td>
          <td class="p-2">${r.nome||'-'}</td>
          <td class="p-2">
            ${(r.whatsapp||'-')}
            ${r.whatsapp?`<button data-copy="${r.whatsapp}" class="btn ml-2 text-xs px-2 py-1 border rounded">copiar</button>`:''}
          </td>
          <td class="p-2">${r.cidade||'-'}</td>
          <td class="p-2">${r.tempo||'-'}</td>
          <td class="p-2">${r.limite!=null?r.limite:'-'}</td>
          <td class="p-2">
            <select data-id="${r.id}" class="status border rounded px-2 py-1">
              ${['Novo','Em contato','Qualificado','Fechado','Descartado'].map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}
            </select>
            <div class="mt-1">${badge(r.status||'Novo')}</div>
          </td>
          <td class="p-2">
            ${r.whatsapp?`<a target="_blank" class="btn text-[var(--brand)] underline" href="https://wa.me/${phone(WPP)}?text=${encodeURIComponent('Olá '+(r.nome||'')+', recebi sua análise da Recupera Crédito. Podemos falar agora?')}">WhatsApp</a>`:''}
          </td>
        </tr>`;
      }).join('');

      lastIds = new Set(rows.map(r=>r.id));
    }

    async function fetchLeads(playPing=true){
      try{
        const r = await fetch('/api/leads');
        if(!r.ok){ // não autenticado
          appBox.classList.add('hidden'); loginBox.classList.remove('hidden'); return;
        }
        const rows = await r.json();
        const before = new Set(ALL.map(x=>x.id));
        ALL = rows;
        applyFilters();

        if(playPing && rows.some(x=>!before.has(x.id))){
          try{
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.type='triangle'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
            o.start(); g.gain.setValueAtTime(.06,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
            setTimeout(()=>o.stop(),260);
          }catch(e){}
        }
      }catch(e){
        toast('Erro ao carregar dados','err');
      }
    }

    // ========= LOGIN/LOGOUT =========
    async function login(data){
      try{
        const r = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        if(r.ok){
          loginBox.classList.add('hidden');
          appBox.classList.remove('hidden');
          loading.classList.remove('hidden'); emptyEl.classList.add('hidden'); tbody.innerHTML='';
          await fetchLeads(false);
          loop();
          toast('Bem-vindo!');
        }else{
          toast('Login inválido','err');
        }
      }catch(e){
        toast('Falha na autenticação','err');
      }
    }

    // ========= EVENTOS =========
    document.getElementById('form-login').addEventListener('submit', e=>{
      e.preventDefault();
      const d = Object.fromEntries(new FormData(e.target).entries());
      login(d);
    });

    document.getElementById('btn-sair').addEventListener('click', async ()=>{
      await fetch('/logout',{method:'POST'});
      clearInterval(poller);
      appBox.classList.add('hidden'); loginBox.classList.remove('hidden');
    });

    document.getElementById('btn-refresh').addEventListener('click', ()=> fetchLeads(false));

    document.getElementById('btn-export').addEventListener('click', ()=>{
      if(!ALL.length){ toast('Sem dados para exportar','err'); return; }
      const blob = new Blob([csv(ALL)], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'leads.csv'; a.click();
    });

    [q,fTipo,fStatus,sortSel].forEach(el=> el.addEventListener('input', applyFilters));

    document.addEventListener('change', async e=>{
      if(e.target.classList.contains('status')){
        const id = e.target.dataset.id, status = e.target.value;
        try{
          const r = await fetch('/api/leads/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})});
          if(r.ok){
            const row = ALL.find(x=>x.id===id); if(row){ row.status = status; applyFilters(); }
            toast('Status atualizado');
          }else{
            toast('Erro ao atualizar status','err');
          }
        }catch(_){ toast('Erro ao atualizar status','err'); }
      }
    });

    document.addEventListener('click', e=>{
      const btn = e.target.closest('[data-copy]');
      if(btn){
        navigator.clipboard.writeText(btn.getAttribute('data-copy'));
        btn.textContent = 'copiado!';
        setTimeout(()=>btn.textContent='copiar', 900);
      }
    });

    // ========= LOOP AUTO-REFRESH =========
    function loop(){ clearInterval(poller); poller = setInterval(fetchLeads, 10000); }

    // tenta carregar se já há sessão
    fetchLeads(false);
  </script>
</body>
</html>
