<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Recupera Crédito</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#101826; --line:#1f2937; --ink:#e5e7eb; --muted:#94a3b8;
      --rose:#e11d48; --amber:#f97316; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .logo{display:flex;gap:10px;align-items:center}
    .dot{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--rose),var(--amber))}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff;cursor:pointer}
    .btn--grad{background:linear-gradient(90deg,var(--rose),var(--amber));border:none;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px} @media(max-width:960px){.grid{grid-template-columns:1fr 1fr}} @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .k strong{font-size:26px;display:block}
    .filters{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px} @media(max-width:960px){.filters{grid-template-columns:1fr 1fr}}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid var(--line);text-align:left;font-size:14px}
    thead th{position:sticky;top:0;background:#0b1220;z-index:2}
    .status{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);display:inline-block}
    .s-novo{background:#0b1220} .s-contato{background:#1e293b} .s-quali{background:#0f766e} .s-fechado{background:#14532d} .s-desc{background:#451a1a}
    /* login modal */
    .overlay{position:fixed;inset:0;background:#0008;display:grid;place-items:center}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><span class="dot"></span><strong>RECUPERA <span style="color:#e11d48">CRÉDITO</span> — Admin</strong></div>
      <div style="display:flex;gap:8px">
        <button id="export" class="btn">Exportar CSV</button>
        <button id="logout" class="btn">Sair</button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="grid">
      <div class="card k"><small style="color:var(--muted)">Total</small><strong id="m-total">0</strong></div>
      <div class="card k"><small style="color:var(--muted)">Novo</small><strong id="m-novo">0</strong></div>
      <div class="card k"><small style="color:var(--muted)">Em contato</small><strong id="m-contato">0</strong></div>
      <div class="card k"><small style="color:var(--muted)">Fechado</small><strong id="m-fechado">0</strong></div>
    </section>

    <!-- Filtros -->
    <section class="card" style="margin-top:14px">
      <div class="filters">
        <input id="q" placeholder="Buscar por nome / WhatsApp / cidade">
        <select id="tipo"><option value="">Tipo (todos)</option><option>PF</option><option>PJ</option></select>
        <select id="status"><option value="">Status (todos)</option><option>Novo</option><option>Em contato</option><option>Qualificado</option><option>Fechado</option><option>Descartado</option></select>
        <select id="sort"><option value="created_at:desc">Mais recentes</option><option value="created_at:asc">Mais antigos</option><option value="nome:asc">Nome (A→Z)</option><option value="nome:desc">Nome (Z→A)</option></select>
        <button id="refresh" class="btn btn--grad">Atualizar</button>
      </div>
    </section>

    <!-- Tabela -->
    <section class="card" style="margin-top:14px">
      <div style="overflow:auto;max-height:60vh">
        <table>
          <thead>
            <tr>
              <th>Quando</th><th>Tipo</th><th>Nome</th><th>WhatsApp</th><th>Cidade</th><th>Tempo</th><th>Limite</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="empty" style="text-align:center;color:var(--muted);padding:18px;display:none">Nenhum registro</div>
    </section>
  </div>

  <!-- Login -->
  <div id="login" class="overlay">
    <div class="card" style="width:min(420px,92vw)">
      <div style="height:4px;background:linear-gradient(90deg,var(--rose),var(--amber));border-radius:999px;margin:-16px -16px 12px"></div>
      <h3 style="margin:0 0 6px">Acesso restrito</h3>
      <p style="margin:0 0 12px;color:var(--muted)">Use suas credenciais para entrar.</p>
      <form id="formLogin">
        <label>Usuário<br><input name="user" value="ADMIN" required></label><br><br>
        <label>Senha<br><input name="pass" type="password" value="recupera123" required></label><br><br>
        <button class="btn btn--grad" style="width:100%">Entrar</button>
        <p style="margin-top:8px;color:var(--muted);font-size:12px">Ex.: <b>ADMIN</b> / <b>recupera123</b></p>
      </form>
    </div>
  </div>

  <script>
    // ----- estado & mocks -----
    let ALL = [];
    const el = s=>document.querySelector(s);
    const rows = el('#rows'), empty = el('#empty');

    function badge(st){
      const map={ 'Novo':'s-novo','Em contato':'s-contato','Qualificado':'s-quali','Fechado':'s-fechado','Descartado':'s-desc' };
      return `<span class="status ${map[st]||'s-novo'}">${st}</span>`;
    }

    function updateKPIs(list){
      el('#m-total').textContent=list.length;
      el('#m-novo').textContent=list.filter(x=>x.status==='Novo').length;
      el('#m-contato').textContent=list.filter(x=>x.status==='Em contato').length;
      el('#m-fechado').textContent=list.filter(x=>x.status==='Fechado').length;
    }

    function apply(){
      let list=[...ALL];
      const q = el('#q').value.trim().toLowerCase();
      const tp = el('#tipo').value;
      const st = el('#status').value;
      const [k,dir] = el('#sort').value.split(':');

      if(q) list=list.filter(r=>(r.nome||'').toLowerCase().includes(q)||(r.whatsapp||'').includes(q)||(r.cidade||'').toLowerCase().includes(q));
      if(tp) list=list.filter(r=>r.tipo===tp);
      if(st) list=list.filter(r=>r.status===st);

      list.sort((a,b)=>{
        const A=(a[k]||'').toString().toLowerCase(), B=(b[k]||'').toString().toLowerCase();
        if(A<B) return dir==='asc'?-1:1; if(A>B) return dir==='asc'?1:-1; return 0;
      });

      rows.innerHTML = list.map(r=>`
        <tr>
          <td>${new Date(r.created_at).toLocaleString('pt-BR')}</td>
          <td>${r.tipo}</td>
          <td>${r.nome||'-'}</td>
          <td>${r.whatsapp||'-'}</td>
          <td>${r.cidade||'-'}</td>
          <td>${r.tempo||'-'}</td>
          <td>${r.limite ?? '-'}</td>
          <td>${badge(r.status||'Novo')}</td>
          <td><button class="btn" data-copy="${r.whatsapp||''}" style="padding:6px 10px;font-size:12px">Copiar</button></td>
        </tr>
      `).join('');

      empty.style.display = list.length? 'none':'block';
      updateKPIs(list);
    }

    async function load(){
      try{
        const r = await fetch('/api/leads'); // se backend existir, usa
        if(!r.ok) throw 0;
        ALL = await r.json();
      }catch(_){
        // mock local (sem backend)
        ALL = [
          {id:'1',created_at:Date.now()-3600e3,tipo:'PF',nome:'Maria',whatsapp:'(11) 99999-0001',cidade:'SP',tempo:'2 meses',limite:3000,status:'Novo'},
          {id:'2',created_at:Date.now()-7200e3,tipo:'PJ',nome:'Oficina Boa',whatsapp:'(21) 98888-0002',cidade:'RJ',tempo:'5 meses',limite:12000,status:'Em contato'},
          {id:'3',created_at:Date.now()-9600e3,tipo:'PF',nome:'Carlos',whatsapp:'(31) 97777-0003',cidade:'BH',tempo:'1 mês',limite:4500,status:'Fechado'}
        ];
      }
      apply();
    }

    // eventos
    ['#q','#tipo','#status','#sort'].forEach(s=>el(s).addEventListener('input',apply));
    rows.addEventListener('click',e=>{
      const b=e.target.closest('[data-copy]'); if(!b) return;
      navigator.clipboard.writeText(b.dataset.copy); b.textContent='Copiado!'; setTimeout(()=>b.textContent='Copiar',800);
    });
    el('#refresh').addEventListener('click',load);
    el('#export').addEventListener('click',()=>{
      if(!ALL.length) return;
      const keys=Object.keys(ALL[0]);
      const csv=[keys.join(',')].concat(ALL.map(r=>keys.map(k=>JSON.stringify(r[k]??'')).join(','))).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='leads.csv'; a.click();
    });
    el('#logout').addEventListener('click',()=>{ document.getElementById('login').classList.remove('hidden'); });

    // login fake local (ADMIN / recupera123)
    document.getElementById('formLogin').addEventListener('submit',e=>{
      e.preventDefault();
      const d=Object.fromEntries(new FormData(e.target).entries());
      if(d.user.toUpperCase()==='ADMIN' && d.pass==='recupera123'){
        document.getElementById('login').classList.add('hidden'); load();
      }else{
        alert('Login inválido');
      }
    });

    // tenta entrar direto (se já tiver sessão no backend, /api/leads responde ok)
    (async ()=>{
      try{ const t=await fetch('/api/leads'); if(t.ok){ document.getElementById('login').classList.add('hidden'); } }catch(_){}
      if(document.getElementById('login').classList.contains('hidden')) load();
    })();
  </script>
</body>
</html>
